import { useNavigate, useLocation } from 'react-router-dom';
import { useGameEngine } from '@/contexts/GameEngineContext';
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { ChevronLeft } from 'lucide-react';
import { GameEngine } from '@/lib/game/GameEngine';
import ShopItemModal from '@/components/game/ShopItemModal';
import ShipPreview from '@/components/game/ShipPreview';

interface ShipSkin {
  id: string;
  name: string;
  description: string;
  price: number;
  isPurchased: boolean;
  isDefault: boolean;
  filter: string;
  previewColor: string;
}

export default function ShopPage() {
  const navigate = useNavigate();
  const location = useLocation();
  const { engine, setEngine } = useGameEngine();
  const [skins, setSkins] = useState<ShipSkin[]>([]);
  const [stardust, setStardust] = useState(0);
  const [activeSkinId, setActiveSkinId] = useState('default');
  const [selectedSkin, setSelectedSkin] = useState<ShipSkin | null>(null);
  const [showPurchaseSuccess, setShowPurchaseSuccess] = useState(false);
  const [purchasedSkinName, setPurchasedSkinName] = useState('');

  // Get return path from location state, default to /game
  const returnPath = (location.state as { from?: string })?.from || '/game';

  // Initialize engine if it doesn't exist
  useEffect(() => {
    if (!engine) {
      const tempCanvas = document.createElement('canvas');
      const newEngine = new GameEngine(tempCanvas, false);
      setEngine(newEngine);
    }
  }, [engine, setEngine]);

  useEffect(() => {
    if (engine) {
      setSkins(engine.cosmeticManager.getAllSkins());
      setStardust(engine.currencyManager.getStardust());
      setActiveSkinId(engine.cosmeticManager.getActiveSkin().id);

      // Listen for currency changes
      const handleCurrencyChange = (event: Event) => {
        const customEvent = event as CustomEvent;
        if (customEvent.detail?.balance !== undefined) {
          setStardust(customEvent.detail.balance);
        }
      };
      window.addEventListener('currency-changed', handleCurrencyChange);

      return () => {
        window.removeEventListener('currency-changed', handleCurrencyChange);
      };
    }
  }, [engine]);

  const handleBack = () => {
    navigate(returnPath, { state: { returnedFrom: 'shop' } });
  };

  const handlePurchase = (skinId: string) => {
    if (engine) {
      const skin = skins.find(s => s.id === skinId);
      const result = engine.cosmeticManager.purchaseSkin(skinId);

      console.log('üõí Purchase attempt:', { skinId, result }); // Debug log

      if (result.success) {
        const updatedSkins = engine.cosmeticManager.getAllSkins();
        setSkins(updatedSkins);
        setStardust(engine.currencyManager.getStardust());

        // Update the selected skin to show the new purchased state
        const updatedSelectedSkin = updatedSkins.find(s => s.id === skinId);
        if (updatedSelectedSkin) {
          setSelectedSkin(updatedSelectedSkin);
        }

        // Show success notification
        if (skin) {
          setPurchasedSkinName(skin.name);
          setShowPurchaseSuccess(true);
          setTimeout(() => setShowPurchaseSuccess(false), 4000);
        }

        console.log('‚úÖ Purchase successful!'); // Debug log
      } else {
        console.error('‚ùå Purchase failed:', result.message); // Debug log
      }
    }
  };

  const handleEquip = (skinId: string) => {
    if (engine) {
      const result = engine.cosmeticManager.equipSkin(skinId);
      if (result.success) {
        setActiveSkinId(skinId);
        setSkins(engine.cosmeticManager.getAllSkins());
      }
    }
  };

  if (!engine) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-[#0a0014] to-[#1a0a2e] flex items-center justify-center">
        <div className="text-white text-xl">Loading Shop...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-[#0a0014] to-[#1a0a2e] text-white overflow-y-auto">
      {/* Header */}
      <div className="sticky top-0 z-50 bg-black/60 backdrop-blur-md border-b border-cyan-400/30">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <button
              onClick={handleBack}
              className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-600/60 to-blue-600/60 hover:from-cyan-500/70 hover:to-blue-500/70 border-2 border-cyan-400/60 rounded-lg transition-all font-['Space_Grotesk'] font-bold shadow-lg shadow-cyan-500/30">
              <ChevronLeft className="w-5 h-5" />
              <span>Back to Game</span>
            </button>

            <h1
              className="text-3xl md:text-4xl font-black font-['Sora'] text-cyan-400"
              style={{ textShadow: '0 0 20px rgba(34, 211, 238, 0.8)' }}>
              üõçÔ∏è SHIP SHOP
            </h1>

            <div className="flex items-center gap-2 px-4 py-2 bg-purple-500/20 border border-purple-400/40 rounded-lg">
              <span className="text-2xl">üíé</span>
              <div className="text-right">
                <div className="text-xs text-purple-300 font-['Space_Grotesk']">Stardust</div>
                <div className="text-xl font-bold text-purple-200">{stardust.toLocaleString()}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="container mx-auto px-4 py-8">
        {/* Intro Text */}
        <div className="mb-8 text-center">
          <p className="text-lg text-cyan-300 font-['Space_Grotesk'] max-w-2xl mx-auto">
            Customize your ship with exclusive skins! Earn Stardust by defeating enemies and unlocking achievements.
          </p>
        </div>

        {/* Skins Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          {skins.map((skin) => {
            const isActive = skin.id === activeSkinId;
            const canAfford = stardust >= skin.price;

            return (
              <motion.div
                key={skin.id}
                className={`bg-gradient-to-br from-purple-900/40 to-pink-900/40 border-2 rounded-xl p-6 transition-all cursor-pointer ${
                  isActive
                    ? 'border-cyan-400 shadow-lg shadow-cyan-400/50'
                    : selectedSkin?.id === skin.id
                    ? 'border-purple-400 shadow-lg shadow-purple-400/30'
                    : 'border-purple-400/30 hover:border-purple-400/60'
                }`}
                onClick={() => setSelectedSkin(skin)}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}>

                {/* Active Badge */}
                {isActive && (
                  <div className="mb-3 inline-block px-3 py-1 bg-cyan-500 text-black text-xs font-bold rounded-full">
                    ‚úì EQUIPPED
                  </div>
                )}

                {/* Default Badge */}
                {skin.isDefault && !isActive && (
                  <div className="mb-3 inline-block px-3 py-1 bg-gray-500/50 text-white text-xs font-bold rounded-full">
                    DEFAULT
                  </div>
                )}

                {/* Ship Preview */}
                <div className="relative h-32 mb-4 flex items-center justify-center bg-black/40 rounded-lg border border-cyan-400/20">
                  <ShipPreview filter={skin.filter} size={64} showEngineGlow={true} />
                </div>

                {/* Name */}
                <h3 className="text-xl font-bold text-white mb-2 font-['Sora']">{skin.name}</h3>

                {/* Description */}
                <p className="text-sm text-cyan-200/80 mb-4 font-['Space_Grotesk']">{skin.description}</p>

                {/* Price / Action - Click to open modal */}
                {skin.isDefault ? (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setSelectedSkin(skin);
                    }}
                    className={`w-full px-4 py-2 rounded-lg font-bold transition-all font-['Space_Grotesk'] ${
                      isActive
                        ? 'bg-gray-600/50 text-gray-400'
                        : 'bg-cyan-500 hover:bg-cyan-400 text-black'
                    }`}>
                    {isActive ? 'Equipped' : 'View Details'}
                  </button>
                ) : skin.isPurchased ? (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setSelectedSkin(skin);
                    }}
                    className={`w-full px-4 py-2 rounded-lg font-bold transition-all font-['Space_Grotesk'] ${
                      isActive
                        ? 'bg-gray-600/50 text-gray-400'
                        : 'bg-cyan-500 hover:bg-cyan-400 text-black'
                    }`}>
                    {isActive ? 'Equipped' : 'Equip Ship'}
                  </button>
                ) : (
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      setSelectedSkin(skin);
                    }}
                    className={`w-full px-4 py-2 rounded-lg font-bold transition-all font-['Space_Grotesk'] flex items-center justify-center gap-2 ${
                      canAfford
                        ? 'bg-purple-500 hover:bg-purple-400 text-white'
                        : 'bg-gray-600/50 text-gray-400'
                    }`}>
                    <span>üíé {skin.price.toLocaleString()}</span>
                    <span>{canAfford ? 'View Details' : 'Not Enough'}</span>
                  </button>
                )}
              </motion.div>
            );
          })}
        </div>

        {/* Footer Tip */}
        <div className="mt-12 text-center">
          <div className="inline-block bg-purple-900/40 border border-purple-400/40 rounded-lg px-6 py-4 max-w-2xl">
            <p className="text-sm text-purple-200 font-['Space_Grotesk']">
              üí° <strong>Tip:</strong> Earn more Stardust by defeating enemies, completing waves, and unlocking achievements!
            </p>
          </div>
        </div>

        {/* Bottom Back Button */}
        <div className="mt-8 mb-8 text-center">
          <button
            onClick={handleBack}
            className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-600/60 to-blue-600/60 hover:from-cyan-500/70 hover:to-blue-500/70 border-2 border-cyan-400/60 rounded-lg transition-all font-['Space_Grotesk'] font-bold shadow-lg shadow-cyan-500/30 mx-auto">
            <ChevronLeft className="w-5 h-5" />
            <span>Back to Game</span>
          </button>
        </div>
      </div>

      {/* Shop Item Modal */}
      {selectedSkin && (
        <ShopItemModal
          skin={selectedSkin}
          onClose={() => setSelectedSkin(null)}
          onPurchase={handlePurchase}
          onEquip={handleEquip}
          canAfford={stardust >= selectedSkin.price}
          isActive={selectedSkin.id === activeSkinId}
        />
      )}

      {/* Purchase Success Notification */}
      <AnimatePresence>
        {showPurchaseSuccess && (
          <motion.div
            className="fixed top-24 left-1/2 -translate-x-1/2 z-[110] bg-gradient-to-r from-green-600 to-emerald-600 border-2 border-green-400 rounded-xl px-8 py-4 shadow-2xl shadow-green-500/50"
            initial={{ opacity: 0, y: -50 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -50 }}
          >
            <div className="text-white font-bold text-center">
              <div className="text-2xl mb-1">üéâ Purchase Successful!</div>
              <div className="text-lg font-['Space_Grotesk']">{purchasedSkinName} unlocked! Click "Equip This Ship" to use it.</div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
